<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ultimix: G:/projects/webdev/wwwroot/ultimix/packages/json/json.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>G:/projects/webdev/wwwroot/ultimix/packages/json/json.php</h1>  </div>
</div>
<div class="contents">
<a href="json_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00058"></a><a class="code" href="json_8php.html#a131a40ade965cdcfcb0cb1a4df4c0e65">00058</a>       define( <span class="stringliteral">&#39;SERVICES_JSON_SLICE&#39;</span> , 1 );
<a name="l00059"></a>00059 
<a name="l00063"></a><a class="code" href="json_8php.html#a4b7b3253265f40348456401b323f0ee0">00063</a>       define( <span class="stringliteral">&#39;SERVICES_JSON_IN_STR&#39;</span> , 2 );
<a name="l00064"></a>00064 
<a name="l00068"></a><a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">00068</a>       define( <span class="stringliteral">&#39;SERVICES_JSON_IN_ARR&#39;</span> , 3 );
<a name="l00069"></a>00069 
<a name="l00073"></a><a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">00073</a>       define( <span class="stringliteral">&#39;SERVICES_JSON_IN_OBJ&#39;</span> , 4 );
<a name="l00074"></a>00074 
<a name="l00078"></a><a class="code" href="json_8php.html#aa92ee6f67987534ea593e755a248929d">00078</a>       define( <span class="stringliteral">&#39;SERVICES_JSON_IN_CMT&#39;</span> , 5 );
<a name="l00079"></a>00079 
<a name="l00083"></a><a class="code" href="json_8php.html#ad49c407e245b546ea6e0223d6e058519">00083</a>       define( <span class="stringliteral">&#39;SERVICES_JSON_LOOSE_TYPE&#39;</span> , 16 );
<a name="l00084"></a>00084 
<a name="l00088"></a><a class="code" href="json_8php.html#a32f0ead758c174c2e5606a073d2ddb57">00088</a>       define( <span class="stringliteral">&#39;SERVICES_JSON_SUPPRESS_ERRORS&#39;</span> , 32 );
<a name="l00089"></a>00089 
<a name="l00111"></a><a class="code" href="classjson__1__0__0.html">00111</a>       <span class="keyword">class </span><a class="code" href="classjson__1__0__0.html">json_1_0_0</a>
<a name="l00112"></a>00112       {
<a name="l00129"></a><a class="code" href="classjson__1__0__0.html#ad3eddaf4bad655b1005b6c2e449eeb6f">00129</a>           function <a class="code" href="classjson__1__0__0.html#ad3eddaf4bad655b1005b6c2e449eeb6f">json_1_0_0</a>($use = 0)
<a name="l00130"></a>00130           {
<a name="l00131"></a>00131               $this-&gt;use = $use;
<a name="l00132"></a>00132           }
<a name="l00133"></a>00133 
<a name="l00144"></a><a class="code" href="classjson__1__0__0.html#aa7b1b36cd3a4995bbb60f5def6a216e2">00144</a>           function <a class="code" href="classjson__1__0__0.html#aa7b1b36cd3a4995bbb60f5def6a216e2">utf162utf8</a>($utf16)
<a name="l00145"></a>00145           {
<a name="l00146"></a>00146               <span class="comment">// oh please oh please oh please oh please oh please</span>
<a name="l00147"></a>00147               <span class="keywordflow">if</span>(function_exists(<span class="stringliteral">&#39;mb_convert_encoding&#39;</span>)) {
<a name="l00148"></a>00148                   <span class="keywordflow">return</span> mb_convert_encoding($utf16, <span class="stringliteral">&#39;UTF-8&#39;</span>, <span class="stringliteral">&#39;UTF-16&#39;</span>);
<a name="l00149"></a>00149               }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151               $bytes = (ord($utf16{0}) &lt;&lt; 8) | ord($utf16{1});
<a name="l00152"></a>00152 
<a name="l00153"></a>00153               <span class="keywordflow">switch</span>(<span class="keyword">true</span>) {
<a name="l00154"></a>00154                   <span class="keywordflow">case</span> ((0x7F &amp; $bytes) == $bytes):
<a name="l00155"></a>00155                       <span class="comment">// this case should never be reached, because we are in ASCII range</span>
<a name="l00156"></a>00156                       <span class="comment">// see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00157"></a>00157                       <span class="keywordflow">return</span> chr(0x7F &amp; $bytes);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159                   <span class="keywordflow">case</span> (0x07FF &amp; $bytes) == $bytes:
<a name="l00160"></a>00160                       <span class="comment">// return a 2-byte UTF-8 character</span>
<a name="l00161"></a>00161                       <span class="comment">// see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00162"></a>00162                       <span class="keywordflow">return</span> chr(0xC0 | (($bytes &gt;&gt; 6) &amp; 0x1F))
<a name="l00163"></a>00163                            . chr(0x80 | ($bytes &amp; 0x3F));
<a name="l00164"></a>00164 
<a name="l00165"></a>00165                   <span class="keywordflow">case</span> (0xFFFF &amp; $bytes) == $bytes:
<a name="l00166"></a>00166                       <span class="comment">// return a 3-byte UTF-8 character</span>
<a name="l00167"></a>00167                       <span class="comment">// see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00168"></a>00168                       <span class="keywordflow">return</span> chr(0xE0 | (($bytes &gt;&gt; 12) &amp; 0x0F))
<a name="l00169"></a>00169                            . chr(0x80 | (($bytes &gt;&gt; 6) &amp; 0x3F))
<a name="l00170"></a>00170                            . chr(0x80 | ($bytes &amp; 0x3F));
<a name="l00171"></a>00171               }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173               <span class="comment">// ignoring UTF-32 for now, sorry</span>
<a name="l00174"></a>00174               <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00175"></a>00175           }
<a name="l00176"></a>00176 
<a name="l00187"></a><a class="code" href="classjson__1__0__0.html#af9687bbf6bcddc9c847d608f9a1fa4c0">00187</a>           function <a class="code" href="classjson__1__0__0.html#af9687bbf6bcddc9c847d608f9a1fa4c0">utf82utf16</a>($utf8)
<a name="l00188"></a>00188           {
<a name="l00189"></a>00189               <span class="comment">// oh please oh please oh please oh please oh please</span>
<a name="l00190"></a>00190               <span class="keywordflow">if</span>(function_exists(<span class="stringliteral">&#39;mb_convert_encoding&#39;</span>)) {
<a name="l00191"></a>00191                   <span class="keywordflow">return</span> mb_convert_encoding($utf8, <span class="stringliteral">&#39;UTF-16&#39;</span>, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l00192"></a>00192               }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194               <span class="keywordflow">switch</span>(strlen($utf8)) {
<a name="l00195"></a>00195                   <span class="keywordflow">case</span> 1:
<a name="l00196"></a>00196                       <span class="comment">// this case should never be reached, because we are in ASCII range</span>
<a name="l00197"></a>00197                       <span class="comment">// see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00198"></a>00198                       <span class="keywordflow">return</span> $utf8;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200                   <span class="keywordflow">case</span> 2:
<a name="l00201"></a>00201                       <span class="comment">// return a UTF-16 character from a 2-byte UTF-8 char</span>
<a name="l00202"></a>00202                       <span class="comment">// see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00203"></a>00203                       <span class="keywordflow">return</span> chr(0x07 &amp; (ord($utf8{0}) &gt;&gt; 2))
<a name="l00204"></a>00204                            . chr((0xC0 &amp; (ord($utf8{0}) &lt;&lt; 6))
<a name="l00205"></a>00205                                | (0x3F &amp; ord($utf8{1})));
<a name="l00206"></a>00206 
<a name="l00207"></a>00207                   <span class="keywordflow">case</span> 3:
<a name="l00208"></a>00208                       <span class="comment">// return a UTF-16 character from a 3-byte UTF-8 char</span>
<a name="l00209"></a>00209                       <span class="comment">// see: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00210"></a>00210                       <span class="keywordflow">return</span> chr((0xF0 &amp; (ord($utf8{0}) &lt;&lt; 4))
<a name="l00211"></a>00211                                | (0x0F &amp; (ord($utf8{1}) &gt;&gt; 2)))
<a name="l00212"></a>00212                            . chr((0xC0 &amp; (ord($utf8{1}) &lt;&lt; 6))
<a name="l00213"></a>00213                                | (0x7F &amp; ord($utf8{2})));
<a name="l00214"></a>00214               }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216               <span class="comment">// ignoring UTF-32 for now, sorry</span>
<a name="l00217"></a>00217               <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00218"></a>00218           }
<a name="l00219"></a>00219 
<a name="l00230"></a><a class="code" href="classjson__1__0__0.html#acdf1c85111e34b3048d436228bf39819">00230</a>           function <a class="code" href="classjson__1__0__0.html#acdf1c85111e34b3048d436228bf39819">encode</a>( $var )
<a name="l00231"></a>00231           {
<a name="l00232"></a>00232                   <span class="keywordflow">if</span>( version_compare( PHP_VERSION , <span class="stringliteral">&#39;5.2.0&#39;</span> ) &gt;= 0 )
<a name="l00233"></a>00233                   {
<a name="l00234"></a>00234                         <span class="keywordflow">return</span>( json_encode( $var ) );
<a name="l00235"></a>00235                   }
<a name="l00236"></a>00236               <span class="keywordflow">switch</span> (gettype($var)) {
<a name="l00237"></a>00237                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;boolean&#39;</span>:
<a name="l00238"></a>00238                       <span class="keywordflow">return</span> $var ? <span class="stringliteral">&#39;true&#39;</span> : <span class="stringliteral">&#39;false&#39;</span>;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;NULL&#39;</span>:
<a name="l00241"></a>00241                       <span class="keywordflow">return</span> <span class="stringliteral">&#39;null&#39;</span>;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;integer&#39;</span>:
<a name="l00244"></a>00244                       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) $var;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;double&#39;</span>:
<a name="l00247"></a>00247                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;float&#39;</span>:
<a name="l00248"></a>00248                       <span class="keywordflow">return</span> (<span class="keywordtype">float</span>) $var;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;string&#39;</span>:
<a name="l00251"></a>00251                       <span class="comment">// STRINGS ARE EXPECTED TO BE IN ASCII OR UTF-8 FORMAT</span>
<a name="l00252"></a>00252                       $ascii = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00253"></a>00253                       $strlen_var = strlen($var);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255                      <span class="comment">/*</span>
<a name="l00256"></a>00256 <span class="comment">                      * Iterate over every character in the string,</span>
<a name="l00257"></a>00257 <span class="comment">                      * escaping with a slash or encoding to UTF-8 where necessary</span>
<a name="l00258"></a>00258 <span class="comment">                      */</span>
<a name="l00259"></a>00259                       <span class="keywordflow">for</span> ($c = 0; $c &lt; $strlen_var; ++$c) {
<a name="l00260"></a>00260 
<a name="l00261"></a>00261                           $ord_var_c = ord($var{$c});
<a name="l00262"></a>00262 
<a name="l00263"></a>00263                           <span class="keywordflow">switch</span> (<span class="keyword">true</span>) {
<a name="l00264"></a>00264                               <span class="keywordflow">case</span> $ord_var_c == 0x08:
<a name="l00265"></a>00265                                   $ascii .= <span class="charliteral">&#39;\b&#39;</span>;
<a name="l00266"></a>00266                                   <span class="keywordflow">break</span>;
<a name="l00267"></a>00267                               <span class="keywordflow">case</span> $ord_var_c == 0x09:
<a name="l00268"></a>00268                                   $ascii .= <span class="charliteral">&#39;\t&#39;</span>;
<a name="l00269"></a>00269                                   <span class="keywordflow">break</span>;
<a name="l00270"></a>00270                               <span class="keywordflow">case</span> $ord_var_c == 0x0A:
<a name="l00271"></a>00271                                   $ascii .= <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00272"></a>00272                                   <span class="keywordflow">break</span>;
<a name="l00273"></a>00273                               <span class="keywordflow">case</span> $ord_var_c == 0x0C:
<a name="l00274"></a>00274                                   $ascii .= <span class="charliteral">&#39;\f&#39;</span>;
<a name="l00275"></a>00275                                   <span class="keywordflow">break</span>;
<a name="l00276"></a>00276                               <span class="keywordflow">case</span> $ord_var_c == 0x0D:
<a name="l00277"></a>00277                                   $ascii .= <span class="charliteral">&#39;\r&#39;</span>;
<a name="l00278"></a>00278                                   <span class="keywordflow">break</span>;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280                               <span class="keywordflow">case</span> $ord_var_c == 0x22:
<a name="l00281"></a>00281                               <span class="keywordflow">case</span> $ord_var_c == 0x2F:
<a name="l00282"></a>00282                               <span class="keywordflow">case</span> $ord_var_c == 0x5C:
<a name="l00283"></a>00283                                   <span class="comment">// double quote, slash, slosh</span>
<a name="l00284"></a>00284                                   $ascii .= <span class="charliteral">&#39;\\&#39;</span>.$var{$c};
<a name="l00285"></a>00285                                   <span class="keywordflow">break</span>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287                               <span class="keywordflow">case</span> (($ord_var_c &gt;= 0x20) &amp;&amp; ($ord_var_c &lt;= 0x7F)):
<a name="l00288"></a>00288                                   <span class="comment">// characters U-00000000 - U-0000007F (same as ASCII)</span>
<a name="l00289"></a>00289                                   $ascii .= $var{$c};
<a name="l00290"></a>00290                                   <span class="keywordflow">break</span>;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292                               <span class="keywordflow">case</span> (($ord_var_c &amp; 0xE0) == 0xC0):
<a name="l00293"></a>00293                                   <span class="comment">// characters U-00000080 - U-000007FF, mask 110XXXXX</span>
<a name="l00294"></a>00294                                   <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00295"></a>00295                                   $char = pack(<span class="stringliteral">&#39;C*&#39;</span>, $ord_var_c, ord($var{$c + 1}));
<a name="l00296"></a>00296                                   $c += 1;
<a name="l00297"></a>00297                                   $utf16 = $this-&gt;<a class="code" href="classjson__1__0__0.html#af9687bbf6bcddc9c847d608f9a1fa4c0">utf82utf16</a>($char);
<a name="l00298"></a>00298                                   $ascii .= sprintf(<span class="stringliteral">&#39;\u%04s&#39;</span>, bin2hex($utf16));
<a name="l00299"></a>00299                                   <span class="keywordflow">break</span>;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                               <span class="keywordflow">case</span> (($ord_var_c &amp; 0xF0) == 0xE0):
<a name="l00302"></a>00302                                   <span class="comment">// characters U-00000800 - U-0000FFFF, mask 1110XXXX</span>
<a name="l00303"></a>00303                                   <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00304"></a>00304                                   $char = pack(<span class="stringliteral">&#39;C*&#39;</span>, $ord_var_c,
<a name="l00305"></a>00305                                                ord($var{$c + 1}),
<a name="l00306"></a>00306                                                ord($var{$c + 2}));
<a name="l00307"></a>00307                                   $c += 2;
<a name="l00308"></a>00308                                   $utf16 = $this-&gt;<a class="code" href="classjson__1__0__0.html#af9687bbf6bcddc9c847d608f9a1fa4c0">utf82utf16</a>($char);
<a name="l00309"></a>00309                                   $ascii .= sprintf(<span class="stringliteral">&#39;\u%04s&#39;</span>, bin2hex($utf16));
<a name="l00310"></a>00310                                   <span class="keywordflow">break</span>;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312                               <span class="keywordflow">case</span> (($ord_var_c &amp; 0xF8) == 0xF0):
<a name="l00313"></a>00313                                   <span class="comment">// characters U-00010000 - U-001FFFFF, mask 11110XXX</span>
<a name="l00314"></a>00314                                   <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00315"></a>00315                                   $char = pack(<span class="stringliteral">&#39;C*&#39;</span>, $ord_var_c,
<a name="l00316"></a>00316                                                ord($var{$c + 1}),
<a name="l00317"></a>00317                                                ord($var{$c + 2}),
<a name="l00318"></a>00318                                                ord($var{$c + 3}));
<a name="l00319"></a>00319                                   $c += 3;
<a name="l00320"></a>00320                                   $utf16 = $this-&gt;<a class="code" href="classjson__1__0__0.html#af9687bbf6bcddc9c847d608f9a1fa4c0">utf82utf16</a>($char);
<a name="l00321"></a>00321                                   $ascii .= sprintf(<span class="stringliteral">&#39;\u%04s&#39;</span>, bin2hex($utf16));
<a name="l00322"></a>00322                                   <span class="keywordflow">break</span>;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324                               <span class="keywordflow">case</span> (($ord_var_c &amp; 0xFC) == 0xF8):
<a name="l00325"></a>00325                                   <span class="comment">// characters U-00200000 - U-03FFFFFF, mask 111110XX</span>
<a name="l00326"></a>00326                                   <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00327"></a>00327                                   $char = pack(<span class="stringliteral">&#39;C*&#39;</span>, $ord_var_c,
<a name="l00328"></a>00328                                                ord($var{$c + 1}),
<a name="l00329"></a>00329                                                ord($var{$c + 2}),
<a name="l00330"></a>00330                                                ord($var{$c + 3}),
<a name="l00331"></a>00331                                                ord($var{$c + 4}));
<a name="l00332"></a>00332                                   $c += 4;
<a name="l00333"></a>00333                                   $utf16 = $this-&gt;<a class="code" href="classjson__1__0__0.html#af9687bbf6bcddc9c847d608f9a1fa4c0">utf82utf16</a>($char);
<a name="l00334"></a>00334                                   $ascii .= sprintf(<span class="stringliteral">&#39;\u%04s&#39;</span>, bin2hex($utf16));
<a name="l00335"></a>00335                                   <span class="keywordflow">break</span>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337                               <span class="keywordflow">case</span> (($ord_var_c &amp; 0xFE) == 0xFC):
<a name="l00338"></a>00338                                   <span class="comment">// characters U-04000000 - U-7FFFFFFF, mask 1111110X</span>
<a name="l00339"></a>00339                                   <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00340"></a>00340                                   $char = pack(<span class="stringliteral">&#39;C*&#39;</span>, $ord_var_c,
<a name="l00341"></a>00341                                                ord($var{$c + 1}),
<a name="l00342"></a>00342                                                ord($var{$c + 2}),
<a name="l00343"></a>00343                                                ord($var{$c + 3}),
<a name="l00344"></a>00344                                                ord($var{$c + 4}),
<a name="l00345"></a>00345                                                ord($var{$c + 5}));
<a name="l00346"></a>00346                                   $c += 5;
<a name="l00347"></a>00347                                   $utf16 = $this-&gt;<a class="code" href="classjson__1__0__0.html#af9687bbf6bcddc9c847d608f9a1fa4c0">utf82utf16</a>($char);
<a name="l00348"></a>00348                                   $ascii .= sprintf(<span class="stringliteral">&#39;\u%04s&#39;</span>, bin2hex($utf16));
<a name="l00349"></a>00349                                   <span class="keywordflow">break</span>;
<a name="l00350"></a>00350                           }
<a name="l00351"></a>00351                       }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353                       <span class="keywordflow">return</span> <span class="charliteral">&#39;&quot;&#39;</span>.$ascii.<span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;array&#39;</span>:
<a name="l00356"></a>00356                      <span class="comment">/*</span>
<a name="l00357"></a>00357 <span class="comment">                      * As per JSON spec if any array key is not an integer</span>
<a name="l00358"></a>00358 <span class="comment">                      * we must treat the the whole array as an object. We</span>
<a name="l00359"></a>00359 <span class="comment">                      * also try to catch a sparsely populated associative</span>
<a name="l00360"></a>00360 <span class="comment">                      * array with numeric keys here because some JS engines</span>
<a name="l00361"></a>00361 <span class="comment">                      * will create an array with empty indexes up to</span>
<a name="l00362"></a>00362 <span class="comment">                      * max_index which can cause memory issues and because</span>
<a name="l00363"></a>00363 <span class="comment">                      * the keys, which may be relevant, will be remapped</span>
<a name="l00364"></a>00364 <span class="comment">                      * otherwise.</span>
<a name="l00365"></a>00365 <span class="comment">                      *</span>
<a name="l00366"></a>00366 <span class="comment">                      * As per the ECMA and JSON specification an object may</span>
<a name="l00367"></a>00367 <span class="comment">                      * have any string as a property. Unfortunately due to</span>
<a name="l00368"></a>00368 <span class="comment">                      * a hole in the ECMA specification if the key is a</span>
<a name="l00369"></a>00369 <span class="comment">                      * ECMA reserved word or starts with a digit the</span>
<a name="l00370"></a>00370 <span class="comment">                      * parameter is only accessible using ECMAScript&#39;s</span>
<a name="l00371"></a>00371 <span class="comment">                      * bracket notation.</span>
<a name="l00372"></a>00372 <span class="comment">                      */</span>
<a name="l00373"></a>00373 
<a name="l00374"></a>00374                       <span class="comment">// treat as a JSON object</span>
<a name="l00375"></a>00375                       <span class="keywordflow">if</span> (is_array($var) &amp;&amp; count($var) &amp;&amp; (array_keys($var) !== range(0, <span class="keyword">sizeof</span>($var) - 1))) {
<a name="l00376"></a>00376                           $properties = array_map(array($this, <span class="stringliteral">&#39;name_value&#39;</span>),
<a name="l00377"></a>00377                                                   array_keys($var),
<a name="l00378"></a>00378                                                   array_values($var));
<a name="l00379"></a>00379 
<a name="l00380"></a>00380                           <span class="keywordflow">foreach</span>($properties as $property) {
<a name="l00381"></a>00381                               <span class="keywordflow">if</span>(<a class="code" href="classjson__1__0__0.html#a55ae0955466c3970507b122f3f5d1b38">json_1_0_0::isError</a>($property)) {
<a name="l00382"></a>00382                                   <span class="keywordflow">return</span> $property;
<a name="l00383"></a>00383                               }
<a name="l00384"></a>00384                           }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386                           <span class="keywordflow">return</span> <span class="charliteral">&#39;{&#39;</span> . join(<span class="charliteral">&#39;,&#39;</span>, $properties) . <span class="charliteral">&#39;}&#39;</span>;
<a name="l00387"></a>00387                       }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389                       <span class="comment">// treat it like a regular array</span>
<a name="l00390"></a>00390                       $elements = array_map(array($this, <span class="stringliteral">&#39;encode&#39;</span>), $var);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392                       <span class="keywordflow">foreach</span>($elements as $element) {
<a name="l00393"></a>00393                           <span class="keywordflow">if</span>(<a class="code" href="classjson__1__0__0.html#a55ae0955466c3970507b122f3f5d1b38">json_1_0_0::isError</a>($element)) {
<a name="l00394"></a>00394                               <span class="keywordflow">return</span> $element;
<a name="l00395"></a>00395                           }
<a name="l00396"></a>00396                       }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398                       <span class="keywordflow">return</span> <span class="charliteral">&#39;[&#39;</span> . join(<span class="charliteral">&#39;,&#39;</span>, $elements) . <span class="charliteral">&#39;]&#39;</span>;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;object&#39;</span>:
<a name="l00401"></a>00401                       $vars = get_object_vars($var);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403                       $properties = array_map(array($this, <span class="stringliteral">&#39;name_value&#39;</span>),
<a name="l00404"></a>00404                                               array_keys($vars),
<a name="l00405"></a>00405                                               array_values($vars));
<a name="l00406"></a>00406 
<a name="l00407"></a>00407                       <span class="keywordflow">foreach</span>($properties as $property) {
<a name="l00408"></a>00408                           <span class="keywordflow">if</span>(<a class="code" href="classjson__1__0__0.html#a55ae0955466c3970507b122f3f5d1b38">json_1_0_0::isError</a>($property)) {
<a name="l00409"></a>00409                               <span class="keywordflow">return</span> $property;
<a name="l00410"></a>00410                           }
<a name="l00411"></a>00411                       }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413                       <span class="keywordflow">return</span> <span class="charliteral">&#39;{&#39;</span> . join(<span class="charliteral">&#39;,&#39;</span>, $properties) . <span class="charliteral">&#39;}&#39;</span>;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415                   <span class="keywordflow">default</span>:
<a name="l00416"></a>00416                       <span class="keywordflow">return</span> ($this-&gt;use &amp; <a class="code" href="json_8php.html#a32f0ead758c174c2e5606a073d2ddb57">SERVICES_JSON_SUPPRESS_ERRORS</a>)
<a name="l00417"></a>00417                           ? <span class="stringliteral">&#39;null&#39;</span>
<a name="l00418"></a>00418                           : <span class="keyword">new</span> Services_JSON_Error(gettype($var).<span class="stringliteral">&quot; can not be encoded as JSON string&quot;</span>);
<a name="l00419"></a>00419               }
<a name="l00420"></a>00420           }
<a name="l00421"></a>00421 
<a name="l00430"></a><a class="code" href="classjson__1__0__0.html#aa7f3e18209717e584f01f53a0325e9ff">00430</a>           function <a class="code" href="classjson__1__0__0.html#aa7f3e18209717e584f01f53a0325e9ff">name_value</a>($name, $value)
<a name="l00431"></a>00431           {
<a name="l00432"></a>00432               $encoded_value = $this-&gt;<a class="code" href="classjson__1__0__0.html#acdf1c85111e34b3048d436228bf39819">encode</a>($value);
<a name="l00433"></a>00433 
<a name="l00434"></a>00434               <span class="keywordflow">if</span>(<a class="code" href="classjson__1__0__0.html#a55ae0955466c3970507b122f3f5d1b38">json_1_0_0::isError</a>($encoded_value)) {
<a name="l00435"></a>00435                   <span class="keywordflow">return</span> $encoded_value;
<a name="l00436"></a>00436               }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438               <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classjson__1__0__0.html#acdf1c85111e34b3048d436228bf39819">encode</a>(strval($name)) . <span class="charliteral">&#39;:&#39;</span> . $encoded_value;
<a name="l00439"></a>00439           }
<a name="l00440"></a>00440 
<a name="l00448"></a><a class="code" href="classjson__1__0__0.html#ae463a3baa44e95fa5b5151ab2334df1c">00448</a>           function <a class="code" href="classjson__1__0__0.html#ae463a3baa44e95fa5b5151ab2334df1c">reduce_string</a>($str)
<a name="l00449"></a>00449           {
<a name="l00450"></a>00450               $str = preg_replace(array(
<a name="l00451"></a>00451 
<a name="l00452"></a>00452                       <span class="comment">// eliminate single line comments in &#39;// ...&#39; form</span>
<a name="l00453"></a>00453                       <span class="stringliteral">&#39;#^\s*//(.+)$#m&#39;</span>,
<a name="l00454"></a>00454 
<a name="l00455"></a>00455                       <span class="comment">// eliminate multi-line comments in &#39;/* ... */&#39; form, at start of string</span>
<a name="l00456"></a>00456                       <span class="stringliteral">&#39;#^\s*/\*(.+)\*/#Us&#39;</span>,
<a name="l00457"></a>00457 
<a name="l00458"></a>00458                       <span class="comment">// eliminate multi-line comments in &#39;/* ... */&#39; form, at end of string</span>
<a name="l00459"></a>00459                       <span class="stringliteral">&#39;#/\*(.+)\*/\s*$#Us&#39;</span>
<a name="l00460"></a>00460 
<a name="l00461"></a>00461                   ), <span class="stringliteral">&#39;&#39;</span>, $str);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463               <span class="comment">// eliminate extraneous space</span>
<a name="l00464"></a>00464               <span class="keywordflow">return</span> trim($str);
<a name="l00465"></a>00465           }
<a name="l00466"></a>00466 
<a name="l00478"></a><a class="code" href="classjson__1__0__0.html#a4afbb486f4a5ff5a8170c832f5997986">00478</a>           function <a class="code" href="classjson__1__0__0.html#a4afbb486f4a5ff5a8170c832f5997986">decode</a>($str)
<a name="l00479"></a>00479           {
<a name="l00480"></a>00480                   <span class="keywordflow">if</span>( version_compare( PHP_VERSION , <span class="stringliteral">&#39;5.2.0&#39;</span> ) &gt;= 0 )
<a name="l00481"></a>00481                   {
<a name="l00482"></a>00482                         <span class="keywordflow">return</span>( json_decode( $var ) );
<a name="l00483"></a>00483                   }
<a name="l00484"></a>00484               $str = $this-&gt;<a class="code" href="classjson__1__0__0.html#ae463a3baa44e95fa5b5151ab2334df1c">reduce_string</a>($str);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486               <span class="keywordflow">switch</span> (strtolower($str)) {
<a name="l00487"></a>00487                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;true&#39;</span>:
<a name="l00488"></a>00488                       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;false&#39;</span>:
<a name="l00491"></a>00491                       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493                   <span class="keywordflow">case</span> <span class="stringliteral">&#39;null&#39;</span>:
<a name="l00494"></a>00494                       <span class="keywordflow">return</span> null;
<a name="l00495"></a>00495 
<a name="l00496"></a>00496                   <span class="keywordflow">default</span>:
<a name="l00497"></a>00497                       $m = array();
<a name="l00498"></a>00498 
<a name="l00499"></a>00499                       <span class="keywordflow">if</span> (is_numeric($str)) {
<a name="l00500"></a>00500                           <span class="comment">// This would work on its own, but I&#39;m trying to be</span>
<a name="l00501"></a>00501                           <span class="comment">// good about returning integers where appropriate:</span>
<a name="l00502"></a>00502                           <span class="comment">// return (float)$str;</span>
<a name="l00503"></a>00503 
<a name="l00504"></a>00504                           <span class="comment">// Return float or int, as appropriate</span>
<a name="l00505"></a>00505                           <span class="keywordflow">return</span> ((<span class="keywordtype">float</span>)$str == (integer)$str)
<a name="l00506"></a>00506                               ? (integer)$str
<a name="l00507"></a>00507                               : (<span class="keywordtype">float</span>)$str;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509                       } elseif (preg_match(<span class="stringliteral">&#39;/^(&quot;|\&#39;).*(\1)$/s&#39;</span>, $str, $m) &amp;&amp; $m[1] == $m[2]) {
<a name="l00510"></a>00510                           <span class="comment">// STRINGS RETURNED IN UTF-8 FORMAT</span>
<a name="l00511"></a>00511                           $delim = substr($str, 0, 1);
<a name="l00512"></a>00512                           $chrs = substr($str, 1, -1);
<a name="l00513"></a>00513                           $utf8 = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00514"></a>00514                           $strlen_chrs = strlen($chrs);
<a name="l00515"></a>00515 
<a name="l00516"></a>00516                           <span class="keywordflow">for</span> ($c = 0; $c &lt; $strlen_chrs; ++$c) {
<a name="l00517"></a>00517 
<a name="l00518"></a>00518                               $substr_chrs_c_2 = substr($chrs, $c, 2);
<a name="l00519"></a>00519                               $ord_chrs_c = ord($chrs{$c});
<a name="l00520"></a>00520 
<a name="l00521"></a>00521                               <span class="keywordflow">switch</span> (<span class="keyword">true</span>) {
<a name="l00522"></a>00522                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="charliteral">&#39;\b&#39;</span>:
<a name="l00523"></a>00523                                       $utf8 .= chr(0x08);
<a name="l00524"></a>00524                                       ++$c;
<a name="l00525"></a>00525                                       <span class="keywordflow">break</span>;
<a name="l00526"></a>00526                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="charliteral">&#39;\t&#39;</span>:
<a name="l00527"></a>00527                                       $utf8 .= chr(0x09);
<a name="l00528"></a>00528                                       ++$c;
<a name="l00529"></a>00529                                       <span class="keywordflow">break</span>;
<a name="l00530"></a>00530                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="charliteral">&#39;\n&#39;</span>:
<a name="l00531"></a>00531                                       $utf8 .= chr(0x0A);
<a name="l00532"></a>00532                                       ++$c;
<a name="l00533"></a>00533                                       <span class="keywordflow">break</span>;
<a name="l00534"></a>00534                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="charliteral">&#39;\f&#39;</span>:
<a name="l00535"></a>00535                                       $utf8 .= chr(0x0C);
<a name="l00536"></a>00536                                       ++$c;
<a name="l00537"></a>00537                                       <span class="keywordflow">break</span>;
<a name="l00538"></a>00538                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="charliteral">&#39;\r&#39;</span>:
<a name="l00539"></a>00539                                       $utf8 .= chr(0x0D);
<a name="l00540"></a>00540                                       ++$c;
<a name="l00541"></a>00541                                       <span class="keywordflow">break</span>;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="stringliteral">&#39;\\&quot;&#39;</span>:
<a name="l00544"></a>00544                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="stringliteral">&#39;\\\&#39;&#39;</span>:
<a name="l00545"></a>00545                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="stringliteral">&#39;\\\\&#39;</span>:
<a name="l00546"></a>00546                                   <span class="keywordflow">case</span> $substr_chrs_c_2 == <span class="stringliteral">&#39;\\/&#39;</span>:
<a name="l00547"></a>00547                                       <span class="keywordflow">if</span> (($delim == <span class="charliteral">&#39;&quot;&#39;</span> &amp;&amp; $substr_chrs_c_2 != <span class="stringliteral">&#39;\\\&#39;&#39;</span>) ||
<a name="l00548"></a>00548                                          ($delim == <span class="stringliteral">&quot;&#39;&quot;</span> &amp;&amp; $substr_chrs_c_2 != <span class="stringliteral">&#39;\\&quot;&#39;</span>)) {
<a name="l00549"></a>00549                                           $utf8 .= $chrs{++$c};
<a name="l00550"></a>00550                                       }
<a name="l00551"></a>00551                                       <span class="keywordflow">break</span>;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553                                   <span class="keywordflow">case</span> preg_match(<span class="stringliteral">&#39;/\\\u[0-9A-F]{4}/i&#39;</span>, substr($chrs, $c, 6)):
<a name="l00554"></a>00554                                       <span class="comment">// single, escaped unicode character</span>
<a name="l00555"></a>00555                                       $utf16 = chr(hexdec(substr($chrs, ($c + 2), 2)))
<a name="l00556"></a>00556                                              . chr(hexdec(substr($chrs, ($c + 4), 2)));
<a name="l00557"></a>00557                                       $utf8 .= $this-&gt;<a class="code" href="classjson__1__0__0.html#aa7b1b36cd3a4995bbb60f5def6a216e2">utf162utf8</a>($utf16);
<a name="l00558"></a>00558                                       $c += 5;
<a name="l00559"></a>00559                                       <span class="keywordflow">break</span>;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561                                   <span class="keywordflow">case</span> ($ord_chrs_c &gt;= 0x20) &amp;&amp; ($ord_chrs_c &lt;= 0x7F):
<a name="l00562"></a>00562                                       $utf8 .= $chrs{$c};
<a name="l00563"></a>00563                                       <span class="keywordflow">break</span>;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                                   <span class="keywordflow">case</span> ($ord_chrs_c &amp; 0xE0) == 0xC0:
<a name="l00566"></a>00566                                       <span class="comment">// characters U-00000080 - U-000007FF, mask 110XXXXX</span>
<a name="l00567"></a>00567                                       <span class="comment">//see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00568"></a>00568                                       $utf8 .= substr($chrs, $c, 2);
<a name="l00569"></a>00569                                       ++$c;
<a name="l00570"></a>00570                                       <span class="keywordflow">break</span>;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572                                   <span class="keywordflow">case</span> ($ord_chrs_c &amp; 0xF0) == 0xE0:
<a name="l00573"></a>00573                                       <span class="comment">// characters U-00000800 - U-0000FFFF, mask 1110XXXX</span>
<a name="l00574"></a>00574                                       <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00575"></a>00575                                       $utf8 .= substr($chrs, $c, 3);
<a name="l00576"></a>00576                                       $c += 2;
<a name="l00577"></a>00577                                       <span class="keywordflow">break</span>;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579                                   <span class="keywordflow">case</span> ($ord_chrs_c &amp; 0xF8) == 0xF0:
<a name="l00580"></a>00580                                       <span class="comment">// characters U-00010000 - U-001FFFFF, mask 11110XXX</span>
<a name="l00581"></a>00581                                       <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00582"></a>00582                                       $utf8 .= substr($chrs, $c, 4);
<a name="l00583"></a>00583                                       $c += 3;
<a name="l00584"></a>00584                                       <span class="keywordflow">break</span>;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586                                   <span class="keywordflow">case</span> ($ord_chrs_c &amp; 0xFC) == 0xF8:
<a name="l00587"></a>00587                                       <span class="comment">// characters U-00200000 - U-03FFFFFF, mask 111110XX</span>
<a name="l00588"></a>00588                                       <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00589"></a>00589                                       $utf8 .= substr($chrs, $c, 5);
<a name="l00590"></a>00590                                       $c += 4;
<a name="l00591"></a>00591                                       <span class="keywordflow">break</span>;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593                                   <span class="keywordflow">case</span> ($ord_chrs_c &amp; 0xFE) == 0xFC:
<a name="l00594"></a>00594                                       <span class="comment">// characters U-04000000 - U-7FFFFFFF, mask 1111110X</span>
<a name="l00595"></a>00595                                       <span class="comment">// see http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8</span>
<a name="l00596"></a>00596                                       $utf8 .= substr($chrs, $c, 6);
<a name="l00597"></a>00597                                       $c += 5;
<a name="l00598"></a>00598                                       <span class="keywordflow">break</span>;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600                               }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602                           }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604                           <span class="keywordflow">return</span> $utf8;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606                       } elseif (preg_match(<span class="stringliteral">&#39;/^\[.*\]$/s&#39;</span>, $str) || preg_match(<span class="stringliteral">&#39;/^\{.*\}$/s&#39;</span>, $str)) {
<a name="l00607"></a>00607                           <span class="comment">// array, or object notation</span>
<a name="l00608"></a>00608 
<a name="l00609"></a>00609                           <span class="keywordflow">if</span> ($str{0} == <span class="charliteral">&#39;[&#39;</span>) {
<a name="l00610"></a>00610                               $stk = array(<a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>);
<a name="l00611"></a>00611                               $arr = array();
<a name="l00612"></a>00612                           } <span class="keywordflow">else</span> {
<a name="l00613"></a>00613                               <span class="keywordflow">if</span> ($this-&gt;use &amp; <a class="code" href="json_8php.html#ad49c407e245b546ea6e0223d6e058519">SERVICES_JSON_LOOSE_TYPE</a>) {
<a name="l00614"></a>00614                                   $stk = array(<a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>);
<a name="l00615"></a>00615                                   $obj = array();
<a name="l00616"></a>00616                               } <span class="keywordflow">else</span> {
<a name="l00617"></a>00617                                   $stk = array(<a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>);
<a name="l00618"></a>00618                                   $obj = <span class="keyword">new</span> stdClass();
<a name="l00619"></a>00619                               }
<a name="l00620"></a>00620                           }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622                           array_push($stk, array(<span class="stringliteral">&#39;what&#39;</span>  =&gt; <a class="code" href="json_8php.html#a131a40ade965cdcfcb0cb1a4df4c0e65">SERVICES_JSON_SLICE</a>,
<a name="l00623"></a>00623                                                  <span class="stringliteral">&#39;where&#39;</span> =&gt; 0,
<a name="l00624"></a>00624                                                  <span class="stringliteral">&#39;delim&#39;</span> =&gt; <span class="keyword">false</span>));
<a name="l00625"></a>00625 
<a name="l00626"></a>00626                           $chrs = substr($str, 1, -1);
<a name="l00627"></a>00627                           $chrs = $this-&gt;<a class="code" href="classjson__1__0__0.html#ae463a3baa44e95fa5b5151ab2334df1c">reduce_string</a>($chrs);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629                           <span class="keywordflow">if</span> ($chrs == <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00630"></a>00630                               <span class="keywordflow">if</span> (reset($stk) == <a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>) {
<a name="l00631"></a>00631                                   <span class="keywordflow">return</span> $arr;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633                               } <span class="keywordflow">else</span> {
<a name="l00634"></a>00634                                   <span class="keywordflow">return</span> $obj;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636                               }
<a name="l00637"></a>00637                           }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639                           $strlen_chrs = strlen($chrs);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641                           <span class="keywordflow">for</span> ($c = 0; $c &lt;= $strlen_chrs; ++$c) {
<a name="l00642"></a>00642 
<a name="l00643"></a>00643                               $top = end($stk);
<a name="l00644"></a>00644                               $substr_chrs_c_2 = substr($chrs, $c, 2);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646                               <span class="keywordflow">if</span> (($c == $strlen_chrs) || (($chrs{$c} == <span class="charliteral">&#39;,&#39;</span>) &amp;&amp; ($top[<span class="stringliteral">&#39;what&#39;</span>] == <a class="code" href="json_8php.html#a131a40ade965cdcfcb0cb1a4df4c0e65">SERVICES_JSON_SLICE</a>))) {
<a name="l00647"></a>00647                                   <span class="comment">// found a comma that is not inside a string, array, etc.,</span>
<a name="l00648"></a>00648                                   <span class="comment">// OR we&#39;ve reached the end of the character list</span>
<a name="l00649"></a>00649                                   $slice = substr($chrs, $top[<span class="stringliteral">&#39;where&#39;</span>], ($c - $top[<span class="stringliteral">&#39;where&#39;</span>]));
<a name="l00650"></a>00650                                   array_push($stk, array(<span class="stringliteral">&#39;what&#39;</span> =&gt; <a class="code" href="json_8php.html#a131a40ade965cdcfcb0cb1a4df4c0e65">SERVICES_JSON_SLICE</a>, <span class="stringliteral">&#39;where&#39;</span> =&gt; ($c + 1), <span class="stringliteral">&#39;delim&#39;</span> =&gt; <span class="keyword">false</span>));
<a name="l00651"></a>00651 
<a name="l00652"></a>00652                                   <span class="keywordflow">if</span> (reset($stk) == <a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>) {
<a name="l00653"></a>00653                                       <span class="comment">// we are in an array, so just push an element onto the stack</span>
<a name="l00654"></a>00654                                       array_push($arr, $this-&gt;<a class="code" href="classjson__1__0__0.html#a4afbb486f4a5ff5a8170c832f5997986">decode</a>($slice));
<a name="l00655"></a>00655 
<a name="l00656"></a>00656                                   } elseif (reset($stk) == <a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>) {
<a name="l00657"></a>00657                                       <span class="comment">// we are in an object, so figure</span>
<a name="l00658"></a>00658                                       <span class="comment">// out the property name and set an</span>
<a name="l00659"></a>00659                                       <span class="comment">// element in an associative array,</span>
<a name="l00660"></a>00660                                       <span class="comment">// for now</span>
<a name="l00661"></a>00661                                       $parts = array();
<a name="l00662"></a>00662                                       
<a name="l00663"></a>00663                                       <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;/^\s*([&quot;\&#39;].*[^\\\][&quot;\&#39;])\s*:\s*(\S.*),?$/Uis&#39;</span>, $slice, $parts)) {
<a name="l00664"></a>00664                                           <span class="comment">// &quot;name&quot;:value pair</span>
<a name="l00665"></a>00665                                           $key = $this-&gt;<a class="code" href="classjson__1__0__0.html#a4afbb486f4a5ff5a8170c832f5997986">decode</a>($parts[1]);
<a name="l00666"></a>00666                                           $val = $this-&gt;<a class="code" href="classjson__1__0__0.html#a4afbb486f4a5ff5a8170c832f5997986">decode</a>($parts[2]);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668                                           <span class="keywordflow">if</span> ($this-&gt;use &amp; <a class="code" href="json_8php.html#ad49c407e245b546ea6e0223d6e058519">SERVICES_JSON_LOOSE_TYPE</a>) {
<a name="l00669"></a>00669                                               $obj[$key] = $val;
<a name="l00670"></a>00670                                           } <span class="keywordflow">else</span> {
<a name="l00671"></a>00671                                               $obj-&gt;$key = $val;
<a name="l00672"></a>00672                                           }
<a name="l00673"></a>00673                                       } elseif (preg_match(<span class="stringliteral">&#39;/^\s*(\w+)\s*:\s*(\S.*),?$/Uis&#39;</span>, $slice, $parts)) {
<a name="l00674"></a>00674                                           <span class="comment">// name:value pair, where name is unquoted</span>
<a name="l00675"></a>00675                                           $key = $parts[1];
<a name="l00676"></a>00676                                           $val = $this-&gt;<a class="code" href="classjson__1__0__0.html#a4afbb486f4a5ff5a8170c832f5997986">decode</a>($parts[2]);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678                                           <span class="keywordflow">if</span> ($this-&gt;use &amp; <a class="code" href="json_8php.html#ad49c407e245b546ea6e0223d6e058519">SERVICES_JSON_LOOSE_TYPE</a>) {
<a name="l00679"></a>00679                                               $obj[$key] = $val;
<a name="l00680"></a>00680                                           } <span class="keywordflow">else</span> {
<a name="l00681"></a>00681                                               $obj-&gt;$key = $val;
<a name="l00682"></a>00682                                           }
<a name="l00683"></a>00683                                       }
<a name="l00684"></a>00684 
<a name="l00685"></a>00685                                   }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687                               } elseif ((($chrs{$c} == <span class="charliteral">&#39;&quot;&#39;</span>) || ($chrs{$c} == <span class="stringliteral">&quot;&#39;&quot;</span>)) &amp;&amp; ($top[<span class="stringliteral">&#39;what&#39;</span>] != <a class="code" href="json_8php.html#a4b7b3253265f40348456401b323f0ee0">SERVICES_JSON_IN_STR</a>)) {
<a name="l00688"></a>00688                                   <span class="comment">// found a quote, and we are not inside a string</span>
<a name="l00689"></a>00689                                   array_push($stk, array(<span class="stringliteral">&#39;what&#39;</span> =&gt; <a class="code" href="json_8php.html#a4b7b3253265f40348456401b323f0ee0">SERVICES_JSON_IN_STR</a>, <span class="stringliteral">&#39;where&#39;</span> =&gt; $c, <span class="stringliteral">&#39;delim&#39;</span> =&gt; $chrs{$c}));
<a name="l00690"></a>00690                               } elseif (($chrs{$c} == $top[<span class="stringliteral">&#39;delim&#39;</span>]) &amp;&amp;
<a name="l00691"></a>00691                                        ($top[<span class="stringliteral">&#39;what&#39;</span>] == <a class="code" href="json_8php.html#a4b7b3253265f40348456401b323f0ee0">SERVICES_JSON_IN_STR</a>) &amp;&amp;
<a name="l00692"></a>00692                                        ((strlen(substr($chrs, 0, $c)) - strlen(rtrim(substr($chrs, 0, $c), <span class="charliteral">&#39;\\&#39;</span>))) % 2 != 1)) {
<a name="l00693"></a>00693                                   <span class="comment">// found a quote, we&#39;re in a string, and it&#39;s not escaped</span>
<a name="l00694"></a>00694                                   <span class="comment">// we know that it&#39;s not escaped becase there is _not_ an</span>
<a name="l00695"></a>00695                                   <span class="comment">// odd number of backslashes at the end of the string so far</span>
<a name="l00696"></a>00696                                   array_pop($stk);
<a name="l00697"></a>00697                               } elseif (($chrs{$c} == <span class="charliteral">&#39;[&#39;</span>) &amp;&amp;
<a name="l00698"></a>00698                                        in_array($top[<span class="stringliteral">&#39;what&#39;</span>], array(<a class="code" href="json_8php.html#a131a40ade965cdcfcb0cb1a4df4c0e65">SERVICES_JSON_SLICE</a>, <a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>, <a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>))) {
<a name="l00699"></a>00699                                   <span class="comment">// found a left-bracket, and we are in an array, object, or slice</span>
<a name="l00700"></a>00700                                   array_push($stk, array(<span class="stringliteral">&#39;what&#39;</span> =&gt; <a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>, <span class="stringliteral">&#39;where&#39;</span> =&gt; $c, <span class="stringliteral">&#39;delim&#39;</span> =&gt; <span class="keyword">false</span>));
<a name="l00701"></a>00701                               } elseif (($chrs{$c} == <span class="charliteral">&#39;]&#39;</span>) &amp;&amp; ($top[<span class="stringliteral">&#39;what&#39;</span>] == <a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>)) {
<a name="l00702"></a>00702                                   <span class="comment">// found a right-bracket, and we&#39;re in an array</span>
<a name="l00703"></a>00703                                   array_pop($stk);
<a name="l00704"></a>00704                               } elseif (($chrs{$c} == <span class="charliteral">&#39;{&#39;</span>) &amp;&amp;
<a name="l00705"></a>00705                                        in_array($top[<span class="stringliteral">&#39;what&#39;</span>], array(<a class="code" href="json_8php.html#a131a40ade965cdcfcb0cb1a4df4c0e65">SERVICES_JSON_SLICE</a>, <a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>, <a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>))) {
<a name="l00706"></a>00706                                   <span class="comment">// found a left-brace, and we are in an array, object, or slice</span>
<a name="l00707"></a>00707                                   array_push($stk, array(<span class="stringliteral">&#39;what&#39;</span> =&gt; <a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>, <span class="stringliteral">&#39;where&#39;</span> =&gt; $c, <span class="stringliteral">&#39;delim&#39;</span> =&gt; <span class="keyword">false</span>));
<a name="l00708"></a>00708                               } elseif (($chrs{$c} == <span class="charliteral">&#39;}&#39;</span>) &amp;&amp; ($top[<span class="stringliteral">&#39;what&#39;</span>] == <a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>)) {
<a name="l00709"></a>00709                                   <span class="comment">// found a right-brace, and we&#39;re in an object</span>
<a name="l00710"></a>00710                                   array_pop($stk);
<a name="l00711"></a>00711                               } elseif (($substr_chrs_c_2 == <span class="stringliteral">&#39;/*&#39;</span>) &amp;&amp;
<a name="l00712"></a>00712                                        in_array($top[<span class="stringliteral">&#39;what&#39;</span>], array(<a class="code" href="json_8php.html#a131a40ade965cdcfcb0cb1a4df4c0e65">SERVICES_JSON_SLICE</a>, <a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>, <a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>))) {
<a name="l00713"></a>00713                                   <span class="comment">// found a comment start, and we are in an array, object, or slice</span>
<a name="l00714"></a>00714                                   array_push($stk, array(<span class="stringliteral">&#39;what&#39;</span> =&gt; <a class="code" href="json_8php.html#aa92ee6f67987534ea593e755a248929d">SERVICES_JSON_IN_CMT</a>, <span class="stringliteral">&#39;where&#39;</span> =&gt; $c, <span class="stringliteral">&#39;delim&#39;</span> =&gt; <span class="keyword">false</span>));
<a name="l00715"></a>00715                                   $c++;
<a name="l00716"></a>00716                               } elseif (($substr_chrs_c_2 == <span class="stringliteral">&#39;*/&#39;</span>) &amp;&amp; ($top[<span class="stringliteral">&#39;what&#39;</span>] == <a class="code" href="json_8php.html#aa92ee6f67987534ea593e755a248929d">SERVICES_JSON_IN_CMT</a>)) {
<a name="l00717"></a>00717                                   <span class="comment">// found a comment end, and we&#39;re in one now</span>
<a name="l00718"></a>00718                                   array_pop($stk);
<a name="l00719"></a>00719                                   $c++;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721                                   <span class="keywordflow">for</span> ($i = $top[<span class="stringliteral">&#39;where&#39;</span>]; $i &lt;= $c; ++$i)
<a name="l00722"></a>00722                                       $chrs = substr_replace($chrs, <span class="charliteral">&#39; &#39;</span>, $i, 1);
<a name="l00723"></a>00723                               }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725                           }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727                           <span class="keywordflow">if</span> (reset($stk) == <a class="code" href="json_8php.html#aa05d94043a2e3adb48a1633dd87bc80c">SERVICES_JSON_IN_ARR</a>) {
<a name="l00728"></a>00728                               <span class="keywordflow">return</span> $arr;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730                           } elseif (reset($stk) == <a class="code" href="json_8php.html#ad4e57f592e491c1a0b1701ee09f231b4">SERVICES_JSON_IN_OBJ</a>) {
<a name="l00731"></a>00731                               <span class="keywordflow">return</span> $obj;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733                           }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735                       }
<a name="l00736"></a>00736               }
<a name="l00737"></a>00737           }
<a name="l00738"></a>00738 
<a name="l00742"></a><a class="code" href="classjson__1__0__0.html#a55ae0955466c3970507b122f3f5d1b38">00742</a>           function <a class="code" href="classjson__1__0__0.html#a55ae0955466c3970507b122f3f5d1b38">isError</a>($data, $code = null)
<a name="l00743"></a>00743           {
<a name="l00744"></a>00744               <span class="keywordflow">if</span> (class_exists(<span class="stringliteral">&#39;pear&#39;</span>)) {
<a name="l00745"></a>00745                   <span class="keywordflow">return</span> <a class="code" href="classjson__1__0__0.html#a55ae0955466c3970507b122f3f5d1b38">PEAR::isError</a>($data, $code);
<a name="l00746"></a>00746               } elseif (is_object($data) &amp;&amp; (get_class($data) == <span class="stringliteral">&#39;services_json_error&#39;</span> ||
<a name="l00747"></a>00747                                        is_subclass_of($data, <span class="stringliteral">&#39;services_json_error&#39;</span>))) {
<a name="l00748"></a>00748                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00749"></a>00749               }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751               <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00752"></a>00752           }
<a name="l00753"></a>00753       }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755       <span class="keywordflow">if</span> (class_exists(<span class="stringliteral">&#39;PEAR_Error&#39;</span>)) {
<a name="l00756"></a>00756           <span class="keyword">class </span>Services_JSON_Error <span class="keyword">extends</span> PEAR_Error
<a name="l00757"></a>00757           {
<a name="l00758"></a>00758               function Services_JSON_Error($message = <span class="stringliteral">&#39;unknown error&#39;</span>, $code = null,
<a name="l00759"></a>00759                                            $mode = null, $options = null, $userinfo = null)
<a name="l00760"></a>00760               {
<a name="l00761"></a>00761                   parent::PEAR_Error($message, $code, $mode, $options, $userinfo);
<a name="l00762"></a>00762               }
<a name="l00763"></a>00763           }
<a name="l00764"></a>00764       } <span class="keywordflow">else</span> {
<a name="l00768"></a>00768           <span class="keyword">class </span>Services_JSON_Error
<a name="l00769"></a>00769           {
<a name="l00770"></a>00770               function Services_JSON_Error($message = <span class="stringliteral">&#39;unknown error&#39;</span>, $code = null,
<a name="l00771"></a>00771                                            $mode = null, $options = null, $userinfo = null)
<a name="l00772"></a>00772               {
<a name="l00773"></a>00773 
<a name="l00774"></a>00774               }
<a name="l00775"></a>00775           }
<a name="l00776"></a>00776       }
<a name="l00777"></a>00777     
<a name="l00778"></a>00778 ?&gt;
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Oct 3 2011 14:49:51 for ultimix by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
