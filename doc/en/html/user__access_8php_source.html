<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ultimix: G:/projects/webdev/wwwroot/ultimix/packages/user/packages/user_access/user_access.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>G:/projects/webdev/wwwroot/ultimix/packages/user/packages/user_access/user_access.php</h1>  </div>
</div>
<div class="contents">
<a href="user__access_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003       <span class="comment">/*</span>
<a name="l00004"></a>00004 <span class="comment">      *     This source code is a part of the Ultimix Project. </span>
<a name="l00005"></a>00005 <span class="comment">      *     It is distributed under BSD license. All other third side source code (like tinyMCE) is distributed under </span>
<a name="l00006"></a>00006 <span class="comment">      *     it&#39;s own license wich could be found from the corresponding files or sources. </span>
<a name="l00007"></a>00007 <span class="comment">      *     This source code is provided &quot;as is&quot; without any warranties or garanties.</span>
<a name="l00008"></a>00008 <span class="comment">      *</span>
<a name="l00009"></a>00009 <span class="comment">      *     Have a nice day!</span>
<a name="l00010"></a>00010 <span class="comment">      *</span>
<a name="l00011"></a>00011 <span class="comment">      *     @url http://ultimix.sorceforge.net</span>
<a name="l00012"></a>00012 <span class="comment">      *</span>
<a name="l00013"></a>00013 <span class="comment">      *     @author Alexey &quot;gdever&quot; Dodonov</span>
<a name="l00014"></a>00014 <span class="comment">      */</span>
<a name="l00015"></a>00015 
<a name="l00026"></a><a class="code" href="classuser__access__1__0__0.html">00026</a>       <span class="keyword">class </span><a class="code" href="classuser__access__1__0__0.html">user_access_1_0_0</a>{
<a name="l00027"></a>00027       
<a name="l00038"></a><a class="code" href="classuser__access__1__0__0.html#a709578c9d5d62ccee7dd9ccba074794a">00038</a>             var                           <a class="code" href="classuser__access__1__0__0.html#a709578c9d5d62ccee7dd9ccba074794a">$NativeTable</a> = <span class="stringliteral">&#39;`umx_user`&#39;</span>;
<a name="l00039"></a>00039       
<a name="l00050"></a><a class="code" href="classuser__access__1__0__0.html#afe99e0304bb11e049a8b8db44818c488">00050</a>             var                           <a class="code" href="classuser__access__1__0__0.html#afe99e0304bb11e049a8b8db44818c488">$GuestUserId</a> = 2;
<a name="l00051"></a>00051       
<a name="l00062"></a><a class="code" href="classuser__access__1__0__0.html#ae10cc045c1502f148d1aa728183898e7">00062</a>             var                           <a class="code" href="classuser__access__1__0__0.html#ae10cc045c1502f148d1aa728183898e7">$Database</a> = <span class="keyword">false</span>;
<a name="l00063"></a><a class="code" href="classuser__access__1__0__0.html#a4e0013647f6f884c8f36c1e9463f10b6">00063</a>             var                           <a class="code" href="classuser__access__1__0__0.html#a4e0013647f6f884c8f36c1e9463f10b6">$DatabaseAlgorithms</a> = <span class="keyword">false</span>;
<a name="l00064"></a><a class="code" href="classuser__access__1__0__0.html#aaae5f70ebc2b60f22e8159944cd2d518">00064</a>             var                           <a class="code" href="classuser__access__1__0__0.html#aaae5f70ebc2b60f22e8159944cd2d518">$Security</a> = <span class="keyword">false</span>;
<a name="l00065"></a>00065             
<a name="l00076"></a><a class="code" href="classuser__access__1__0__0.html#a5b8fcdddb7f688fbb9770422e56dd5cb">00076</a>             var                           <a class="code" href="classuser__access__1__0__0.html#a5b8fcdddb7f688fbb9770422e56dd5cb">$UsersCache</a> = array();
<a name="l00077"></a>00077             
<a name="l00088"></a><a class="code" href="classuser__access__1__0__0.html#a095c5d389db211932136b53f25f39685">00088</a>             function                <a class="code" href="classuser__access__1__0__0.html#a095c5d389db211932136b53f25f39685">__construct</a>()
<a name="l00089"></a>00089             {
<a name="l00090"></a>00090                   <span class="keywordflow">try</span>
<a name="l00091"></a>00091                   {
<a name="l00092"></a>00092                         $this-&gt;Database = <a class="code" href="core__public__api_8php.html#a3ba50cf690fa88e981b38b4779f18759">get_package</a>( <span class="stringliteral">&#39;database&#39;</span> , <span class="stringliteral">&#39;last&#39;</span> , __FILE__ );
<a name="l00093"></a>00093                         $this-&gt;DatabaseAlgorithms = <a class="code" href="core__public__api_8php.html#a3ba50cf690fa88e981b38b4779f18759">get_package</a>( <span class="stringliteral">&#39;database::database_algorithms&#39;</span> , <span class="stringliteral">&#39;last&#39;</span> , __FILE__ );
<a name="l00094"></a>00094                         $this-&gt;Security = <a class="code" href="core__public__api_8php.html#a3ba50cf690fa88e981b38b4779f18759">get_package</a>( <span class="stringliteral">&#39;security&#39;</span> , <span class="stringliteral">&#39;last&#39;</span> , __FILE__ );
<a name="l00095"></a>00095                   }
<a name="l00096"></a>00096                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00097"></a>00097                   {
<a name="l00098"></a>00098                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00099"></a>00099                   }
<a name="l00100"></a>00100             }
<a name="l00101"></a>00101       
<a name="l00112"></a><a class="code" href="classuser__access__1__0__0.html#a13352aef27c96654b4751d67b2cacfe9">00112</a>             var                           <a class="code" href="classuser__access__1__0__0.html#a13352aef27c96654b4751d67b2cacfe9">$AddLimitations</a> = <span class="stringliteral">&#39;1 = 1&#39;</span>;
<a name="l00113"></a>00113             
<a name="l00132"></a><a class="code" href="classuser__access__1__0__0.html#a53b3ad2447b87fa67af6d3a67e1b4ef6">00132</a>             function                <a class="code" href="classuser__access__1__0__0.html#a53b3ad2447b87fa67af6d3a67e1b4ef6">set_add_limitations</a>( $theAddLimitation )
<a name="l00133"></a>00133             {
<a name="l00134"></a>00134                   <span class="keywordflow">try</span>
<a name="l00135"></a>00135                   {
<a name="l00136"></a>00136                         <span class="keywordflow">if</span>( $this-&gt;AddLimitations === <span class="stringliteral">&#39;1 = 1&#39;</span> )
<a name="l00137"></a>00137                         {
<a name="l00138"></a>00138                               $this-&gt;AddLimitations = $theAddLimitation;
<a name="l00139"></a>00139                         }
<a name="l00140"></a>00140                         <span class="keywordflow">else</span>
<a name="l00141"></a>00141                         {
<a name="l00142"></a>00142                               <span class="keywordflow">throw</span>( <span class="keyword">new</span> Exception( <span class="stringliteral">&#39;&quot;AddLimitations&quot; was already set&#39;</span> ) );
<a name="l00143"></a>00143                         }
<a name="l00144"></a>00144                   }
<a name="l00145"></a>00145                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00146"></a>00146                   {
<a name="l00147"></a>00147                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00148"></a>00148                   }
<a name="l00149"></a>00149             }
<a name="l00150"></a>00150       
<a name="l00177"></a><a class="code" href="classuser__access__1__0__0.html#a43bcb1bbf7b5be538c27b03543c63208">00177</a>             function                <a class="code" href="classuser__access__1__0__0.html#a43bcb1bbf7b5be538c27b03543c63208">unsafe_select</a>( $Condition = <span class="stringliteral">&#39;1 = 1&#39;</span> )
<a name="l00178"></a>00178             {
<a name="l00179"></a>00179                   <span class="keywordflow">try</span>
<a name="l00180"></a>00180                   {
<a name="l00181"></a>00181                         $this-&gt;Database-&gt;query_as( <a class="code" href="database_8php.html#acaeb4240927648affc96a96788ea2b26">DB_OBJECT</a> );
<a name="l00182"></a>00182 
<a name="l00183"></a>00183                         <span class="keywordflow">return</span>( 
<a name="l00184"></a>00184                               $this-&gt;Database-&gt;select( 
<a name="l00185"></a>00185                                     $this-&gt;NativeTable.<span class="stringliteral">&#39;.* , file_path AS avatar_path , &#39;</span>.
<a name="l00186"></a>00186                                           <span class="stringliteral">&#39;IF( banned_to &gt;= NOW() , 1 , 0 ) AS banned&#39;</span> , 
<a name="l00187"></a>00187                                     $this-&gt;NativeTable.<span class="stringliteral">&#39; , umx_uploaded_file&#39;</span> , 
<a name="l00188"></a>00188                                     <span class="stringliteral">&quot;( $this-&gt;AddLimitations ) AND umx_uploaded_file.id = &quot;</span>.
<a name="l00189"></a>00189                                           $this-&gt;NativeTable.<span class="stringliteral">&quot;.avatar AND $Condition&quot;</span> 
<a name="l00190"></a>00190                               )
<a name="l00191"></a>00191                         );
<a name="l00192"></a>00192                   }
<a name="l00193"></a>00193                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00194"></a>00194                   {
<a name="l00195"></a>00195                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00196"></a>00196                   }
<a name="l00197"></a>00197             }
<a name="l00198"></a>00198             
<a name="l00221"></a><a class="code" href="classuser__access__1__0__0.html#ae097254ab0ed15bbdd74bd12ac934e0b">00221</a>             function                <a class="code" href="classuser__access__1__0__0.html#ae097254ab0ed15bbdd74bd12ac934e0b">email_exists</a>( $Email )
<a name="l00222"></a>00222             {
<a name="l00223"></a>00223                   <span class="keywordflow">try</span>
<a name="l00224"></a>00224                   {
<a name="l00225"></a>00225                         $Email = $this-&gt;Security-&gt;get( $Email , <span class="stringliteral">&#39;email&#39;</span> );
<a name="l00226"></a>00226                         
<a name="l00227"></a>00227                         $Records = $this-&gt;<a class="code" href="classuser__access__1__0__0.html#a43bcb1bbf7b5be538c27b03543c63208">unsafe_select</a>( <span class="stringliteral">&quot;email LIKE &#39;$Email&#39;&quot;</span> );
<a name="l00228"></a>00228                         
<a name="l00229"></a>00229                         <span class="keywordflow">return</span>( count( $Records ) == 1 );
<a name="l00230"></a>00230                   }
<a name="l00231"></a>00231                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00232"></a>00232                   {
<a name="l00233"></a>00233                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00234"></a>00234                   }
<a name="l00235"></a>00235             }
<a name="l00236"></a>00236             
<a name="l00259"></a><a class="code" href="classuser__access__1__0__0.html#abe83ed68d0e9c9dfda799ccfae94433b">00259</a>             function                <a class="code" href="classuser__access__1__0__0.html#abe83ed68d0e9c9dfda799ccfae94433b">get_user</a>( $Login )
<a name="l00260"></a>00260             {
<a name="l00261"></a>00261                   <span class="keywordflow">try</span>
<a name="l00262"></a>00262                   {
<a name="l00263"></a>00263                         <span class="keywordflow">if</span>( isset( $this-&gt;UsersCache[ $Login ] ) )
<a name="l00264"></a>00264                         {
<a name="l00265"></a>00265                               <span class="keywordflow">return</span>( $this-&gt;UsersCache[ $Login ] );
<a name="l00266"></a>00266                         }
<a name="l00267"></a>00267                         
<a name="l00268"></a>00268                         $Login = $this-&gt;Security-&gt;get( $Login , <span class="stringliteral">&#39;command&#39;</span> );
<a name="l00269"></a>00269                         
<a name="l00270"></a>00270                         $Users = $this-&gt;<a class="code" href="classuser__access__1__0__0.html#a43bcb1bbf7b5be538c27b03543c63208">unsafe_select</a>( <span class="stringliteral">&quot;login LIKE &#39;$Login&#39;&quot;</span> );
<a name="l00271"></a>00271                         
<a name="l00272"></a>00272                         <span class="keywordflow">if</span>( count( $Users ) === 0 || count( $Users ) &gt; 1 )
<a name="l00273"></a>00273                         {
<a name="l00274"></a>00274                               <span class="keywordflow">throw</span>( <span class="keyword">new</span> Exception( <span class="stringliteral">&#39;User with login &#39;</span>.$Login.<span class="stringliteral">&#39; was not found&#39;</span> ) );
<a name="l00275"></a>00275                         }
<a name="l00276"></a>00276                         <span class="keywordflow">else</span>
<a name="l00277"></a>00277                         {
<a name="l00278"></a>00278                               $this-&gt;UsersCache[ $Login ] = $Users[ 0 ];
<a name="l00279"></a>00279                               <span class="keywordflow">return</span>( $Users[ 0 ] );
<a name="l00280"></a>00280                         }
<a name="l00281"></a>00281                   }
<a name="l00282"></a>00282                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00283"></a>00283                   {
<a name="l00284"></a>00284                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00285"></a>00285                   }
<a name="l00286"></a>00286             }
<a name="l00287"></a>00287             
<a name="l00318"></a><a class="code" href="classuser__access__1__0__0.html#a55bd83cc71f562d802e045a08bdfa9d0">00318</a>             function                <a class="code" href="classuser__access__1__0__0.html#a55bd83cc71f562d802e045a08bdfa9d0">validate_auth</a>( $Login , $Password , $HashPassed = <span class="keyword">false</span> )
<a name="l00319"></a>00319             {
<a name="l00320"></a>00320                   <span class="keywordflow">try</span>
<a name="l00321"></a>00321                   {
<a name="l00322"></a>00322                         $Login = $this-&gt;Security-&gt;get( $Login , <span class="stringliteral">&#39;command&#39;</span> );
<a name="l00323"></a>00323                         $Password = $this-&gt;Security-&gt;get( $Password , <span class="stringliteral">&#39;string&#39;</span> );
<a name="l00324"></a>00324                         
<a name="l00325"></a>00325                         $User = $this-&gt;<a class="code" href="classuser__access__1__0__0.html#abe83ed68d0e9c9dfda799ccfae94433b">get_user</a>( $Login );
<a name="l00326"></a>00326                         
<a name="l00327"></a>00327                         <span class="keywordflow">if</span>( $HashPassed )
<a name="l00328"></a>00328                         {
<a name="l00329"></a>00329                               <span class="keywordflow">return</span>( $Password == <a class="code" href="functional__programming_8php.html#a113f39218a0e805d475fbc5ab87a16ab">get_field</a>( $User , <span class="stringliteral">&#39;password&#39;</span> ) );
<a name="l00330"></a>00330                         }
<a name="l00331"></a>00331                         <span class="keywordflow">else</span>
<a name="l00332"></a>00332                         {
<a name="l00333"></a>00333                               <span class="keywordflow">return</span>( md5( $Password ) == <a class="code" href="functional__programming_8php.html#a113f39218a0e805d475fbc5ab87a16ab">get_field</a>( $User , <span class="stringliteral">&#39;password&#39;</span> ) );
<a name="l00334"></a>00334                         }
<a name="l00335"></a>00335                   }
<a name="l00336"></a>00336                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00337"></a>00337                   {
<a name="l00338"></a>00338                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00339"></a>00339                   }
<a name="l00340"></a>00340             }
<a name="l00341"></a>00341             
<a name="l00364"></a><a class="code" href="classuser__access__1__0__0.html#ada914f922688b9f9c1ba0cc48f86a0f2">00364</a>             function                <a class="code" href="classuser__access__1__0__0.html#ada914f922688b9f9c1ba0cc48f86a0f2">reset_password</a>( $Login , $Password )
<a name="l00365"></a>00365             {
<a name="l00366"></a>00366                   <span class="keywordflow">try</span>
<a name="l00367"></a>00367                   {
<a name="l00368"></a>00368                         $Login = $this-&gt;Security-&gt;get( $Login , <span class="stringliteral">&#39;command&#39;</span> );
<a name="l00369"></a>00369                         $Password = $this-&gt;Security-&gt;get( $Password , <span class="stringliteral">&#39;string&#39;</span> );
<a name="l00370"></a>00370 
<a name="l00371"></a>00371                         $this-&gt;Database-&gt;update( 
<a name="l00372"></a>00372                               $this-&gt;NativeTable , array( <span class="stringliteral">&#39;password&#39;</span> ) , array( <span class="stringliteral">&quot;md5( &#39;$Password&#39; )&quot;</span> ) , <span class="stringliteral">&quot;login LIKE &#39;$Login&#39;&quot;</span>
<a name="l00373"></a>00373                         );
<a name="l00374"></a>00374                         $this-&gt;Database-&gt;commit();
<a name="l00375"></a>00375                   }
<a name="l00376"></a>00376                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00377"></a>00377                   {
<a name="l00378"></a>00378                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00379"></a>00379                   }
<a name="l00380"></a>00380             }
<a name="l00381"></a>00381             
<a name="l00404"></a><a class="code" href="classuser__access__1__0__0.html#a244568bdd4ba88bf6f31b841460c3254">00404</a>             function                <a class="code" href="classuser__access__1__0__0.html#a244568bdd4ba88bf6f31b841460c3254">set_avatar</a>( $Login , $ImageId )
<a name="l00405"></a>00405             {
<a name="l00406"></a>00406                   <span class="keywordflow">try</span>
<a name="l00407"></a>00407                   {
<a name="l00408"></a>00408                         $Login = $this-&gt;Security-&gt;get( $Login , <span class="stringliteral">&#39;command&#39;</span> );
<a name="l00409"></a>00409                         $ImageId = $this-&gt;Security-&gt;get( $ImageId , <span class="stringliteral">&#39;integer&#39;</span> );
<a name="l00410"></a>00410 
<a name="l00411"></a>00411                         $this-&gt;Database-&gt;update( 
<a name="l00412"></a>00412                               $this-&gt;NativeTable , array( <span class="stringliteral">&#39;avatar&#39;</span> ) , array( $ImageId ) , <span class="stringliteral">&quot;login LIKE &#39;$Login&#39;&quot;</span>
<a name="l00413"></a>00413                         );
<a name="l00414"></a>00414                         $this-&gt;Database-&gt;commit();
<a name="l00415"></a>00415                   }
<a name="l00416"></a>00416                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00417"></a>00417                   {
<a name="l00418"></a>00418                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00419"></a>00419                   }
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421             
<a name="l00444"></a><a class="code" href="classuser__access__1__0__0.html#a8d23ea5c69d9c3a439f5484e9ca33022">00444</a>             function                <a class="code" href="classuser__access__1__0__0.html#a8d23ea5c69d9c3a439f5484e9ca33022">update</a>( $id , $Record )
<a name="l00445"></a>00445             {
<a name="l00446"></a>00446                   <span class="keywordflow">try</span>
<a name="l00447"></a>00447                   {
<a name="l00448"></a>00448                         $id = $this-&gt;Security-&gt;get( $id , <span class="stringliteral">&#39;integer_list&#39;</span> );
<a name="l00449"></a>00449                         $Record = $this-&gt;Security-&gt;parse_parameters( 
<a name="l00450"></a>00450                               $Record , 
<a name="l00451"></a>00451                               <span class="stringliteral">&#39;password:string;email:email;active:command;active_to:string;&#39;</span>.
<a name="l00452"></a>00452                                     <span class="stringliteral">&#39;banned_to:string;name:string;sex:integer;site:string;about:string&#39;</span> , 
<a name="l00453"></a>00453                               <span class="stringliteral">&#39;allow_not_set&#39;</span>
<a name="l00454"></a>00454                         );
<a name="l00455"></a>00455 
<a name="l00456"></a>00456                         $Fields = array();
<a name="l00457"></a>00457                         $Values = array();
<a name="l00458"></a>00458                         
<a name="l00459"></a>00459                         <span class="keywordflow">foreach</span>( $Record as $f =&gt; $v )
<a name="l00460"></a>00460                         {
<a name="l00461"></a>00461                               <span class="keywordflow">if</span>( $f == <span class="stringliteral">&#39;sex&#39;</span> )
<a name="l00462"></a>00462                               {
<a name="l00463"></a>00463                                     <span class="keywordflow">if</span>( $v != 1 &amp;&amp; $v != 2 )
<a name="l00464"></a>00464                                     {
<a name="l00465"></a>00465                                           $v = 0;
<a name="l00466"></a>00466                                     }
<a name="l00467"></a>00467                                     $Fields [] = $f;
<a name="l00468"></a>00468                                     $Values [] = $v;
<a name="l00469"></a>00469                               }
<a name="l00470"></a>00470                               <span class="keywordflow">if</span>( $f == <span class="stringliteral">&#39;active&#39;</span> )
<a name="l00471"></a>00471                               {
<a name="l00472"></a>00472                                     <span class="keywordflow">if</span>( $v == <span class="stringliteral">&#39;on&#39;</span> )
<a name="l00473"></a>00473                                     {
<a name="l00474"></a>00474                                           $Fields [] = $f;
<a name="l00475"></a>00475                                           $Values [] = <span class="stringliteral">&quot;&#39;active&#39;&quot;</span>;
<a name="l00476"></a>00476                                     }
<a name="l00477"></a>00477                                     <span class="keywordflow">if</span>( $v == <span class="stringliteral">&#39;deactivate&#39;</span> )
<a name="l00478"></a>00478                                     {
<a name="l00479"></a>00479                                           $Fields [] = $f;
<a name="l00480"></a>00480                                           $Values [] = <span class="stringliteral">&quot;&#39;&quot;</span>.md5( microtime() ).<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00481"></a>00481                                     }
<a name="l00482"></a>00482                                     <span class="keywordflow">continue</span>;
<a name="l00483"></a>00483                               }
<a name="l00484"></a>00484                               <span class="keywordflow">if</span>( $f == <span class="stringliteral">&#39;password&#39;</span> )
<a name="l00485"></a>00485                               {
<a name="l00486"></a>00486                                     <span class="keywordflow">if</span>( $v == <span class="stringliteral">&#39;&#39;</span> )
<a name="l00487"></a>00487                                     {
<a name="l00488"></a>00488                                           <span class="comment">/* nop */</span>
<a name="l00489"></a>00489                                     }
<a name="l00490"></a>00490                                     <span class="keywordflow">else</span>
<a name="l00491"></a>00491                                     {
<a name="l00492"></a>00492                                           $Fields [] = $f;
<a name="l00493"></a>00493                                           $Values [] = <span class="stringliteral">&quot;&#39;&quot;</span>.md5( $v ).<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00494"></a>00494                                     }
<a name="l00495"></a>00495                                     <span class="keywordflow">continue</span>;
<a name="l00496"></a>00496                               }
<a name="l00497"></a>00497                               <span class="keywordflow">if</span>( $v !== <span class="stringliteral">&#39;_no_update&#39;</span> )
<a name="l00498"></a>00498                               {
<a name="l00499"></a>00499                                     $Fields [] = $f;
<a name="l00500"></a>00500                                     <span class="keywordflow">if</span>( is_integer( $v ) )
<a name="l00501"></a>00501                                     {
<a name="l00502"></a>00502                                           $Values [] = $v;
<a name="l00503"></a>00503                                     }
<a name="l00504"></a>00504                                     <span class="keywordflow">else</span>
<a name="l00505"></a>00505                                     {
<a name="l00506"></a>00506                                           $Values [] = <span class="stringliteral">&quot;&#39;&quot;</span>.$v.<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00507"></a>00507                                     }
<a name="l00508"></a>00508                               }
<a name="l00509"></a>00509                         }
<a name="l00510"></a>00510                         
<a name="l00511"></a>00511                         <span class="keywordflow">if</span>( count( $Fields ) )
<a name="l00512"></a>00512                         {
<a name="l00513"></a>00513                               $this-&gt;Database = <a class="code" href="core__public__api_8php.html#a3ba50cf690fa88e981b38b4779f18759">get_package</a>( <span class="stringliteral">&#39;database&#39;</span> , <span class="stringliteral">&#39;last&#39;</span> , __FILE__ );
<a name="l00514"></a>00514                               $this-&gt;Database-&gt;update( 
<a name="l00515"></a>00515                                     $this-&gt;NativeTable , $Fields , $Values , <span class="stringliteral">&quot;( $this-&gt;AddLimitations ) AND id IN ( $id )&quot;</span>
<a name="l00516"></a>00516                               );
<a name="l00517"></a>00517                               $this-&gt;Database-&gt;commit();
<a name="l00518"></a>00518                               
<a name="l00519"></a>00519                               $EventManager = <a class="code" href="core__public__api_8php.html#a3ba50cf690fa88e981b38b4779f18759">get_package</a>( <span class="stringliteral">&#39;event_manager&#39;</span> , <span class="stringliteral">&#39;last&#39;</span> , __FILE__ );
<a name="l00520"></a>00520                               $EventManager-&gt;trigger_event( <span class="stringliteral">&#39;on_after_update_user&#39;</span> , array( <span class="stringliteral">&#39;id&#39;</span> =&gt; $id ) );
<a name="l00521"></a>00521                               
<a name="l00522"></a>00522                               $EventManager-&gt;trigger_event( <span class="stringliteral">&#39;anonimous&#39;</span> , array( <span class="stringliteral">&#39;master_id&#39;</span> =&gt; $id , <span class="stringliteral">&#39;master_type&#39;</span> =&gt; <span class="stringliteral">&#39;user&#39;</span> ) );
<a name="l00523"></a>00523                         }
<a name="l00524"></a>00524                   }
<a name="l00525"></a>00525                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00526"></a>00526                   {
<a name="l00527"></a>00527                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00528"></a>00528                   }
<a name="l00529"></a>00529             }
<a name="l00530"></a>00530             
<a name="l00549"></a><a class="code" href="classuser__access__1__0__0.html#a2d7f897ac0256b7a90c46716cf939281">00549</a>             function                <span class="keyword">delete</span>( $ids )
<a name="l00550"></a>00550             {
<a name="l00551"></a>00551                   <span class="keywordflow">try</span>
<a name="l00552"></a>00552                   {
<a name="l00553"></a>00553                         $ids = $this-&gt;Security-&gt;get( $ids , <span class="stringliteral">&#39;integer_list&#39;</span> );
<a name="l00554"></a>00554                         
<a name="l00555"></a>00555                         $this-&gt;Database-&gt;delete( $this-&gt;NativeTable , <span class="stringliteral">&quot;( $this-&gt;AddLimitations ) AND id IN ( $ids )&quot;</span> );
<a name="l00556"></a>00556                         $this-&gt;Database-&gt;commit();
<a name="l00557"></a>00557                         
<a name="l00558"></a>00558                         $Link = <a class="code" href="core__public__api_8php.html#a3ba50cf690fa88e981b38b4779f18759">get_package</a>( <span class="stringliteral">&#39;link&#39;</span> , <span class="stringliteral">&#39;last&#39;</span> , __FILE__ );
<a name="l00559"></a>00559                         $Link-&gt;delete_link( <span class="stringliteral">&quot;$ids&quot;</span> , <span class="keyword">false</span> , <span class="stringliteral">&#39;user&#39;</span> , <span class="stringliteral">&#39;permit&#39;</span> );
<a name="l00560"></a>00560                         $Link-&gt;delete_link( <span class="stringliteral">&quot;$ids&quot;</span> , <span class="keyword">false</span> , <span class="stringliteral">&#39;user&#39;</span> , <span class="stringliteral">&#39;group&#39;</span> );
<a name="l00561"></a>00561                   }
<a name="l00562"></a>00562                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00563"></a>00563                   {
<a name="l00564"></a>00564                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00565"></a>00565                   }
<a name="l00566"></a>00566             }
<a name="l00567"></a>00567             
<a name="l00586"></a><a class="code" href="classuser__access__1__0__0.html#a9714ff1ebcc55b34b535a2caa621a164">00586</a>             function                <a class="code" href="classuser__access__1__0__0.html#a9714ff1ebcc55b34b535a2caa621a164">activate_user</a>( $Hash )
<a name="l00587"></a>00587             {
<a name="l00588"></a>00588                   <span class="keywordflow">try</span>
<a name="l00589"></a>00589                   {
<a name="l00590"></a>00590                         $Hash = $this-&gt;Security-&gt;get( $Hash , <span class="stringliteral">&#39;command&#39;</span> );
<a name="l00591"></a>00591                         
<a name="l00592"></a>00592                         $this-&gt;Database-&gt;update( 
<a name="l00593"></a>00593                               $this-&gt;NativeTable , 
<a name="l00594"></a>00594                               array( <span class="stringliteral">&#39;active&#39;</span> ) , array( <span class="stringliteral">&quot;&#39;active&#39;&quot;</span> ) , 
<a name="l00595"></a>00595                               <span class="stringliteral">&quot;( $this-&gt;AddLimitations ) AND active LIKE &#39;$Hash&#39;&quot;</span>
<a name="l00596"></a>00596                         );
<a name="l00597"></a>00597                         
<a name="l00598"></a>00598                         $this-&gt;Database-&gt;commit();
<a name="l00599"></a>00599                   }
<a name="l00600"></a>00600                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00601"></a>00601                   {
<a name="l00602"></a>00602                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00603"></a>00603                   }
<a name="l00604"></a>00604             }
<a name="l00605"></a>00605             
<a name="l00654"></a><a class="code" href="classuser__access__1__0__0.html#a259e838928050781723393f204287ab7">00654</a>             function                <a class="code" href="classuser__access__1__0__0.html#a259e838928050781723393f204287ab7">register_user</a>( $Login , $Password , $Email , $Name , $Sex , $Site , $About )
<a name="l00655"></a>00655             {
<a name="l00656"></a>00656                   <span class="keywordflow">try</span>
<a name="l00657"></a>00657                   {
<a name="l00658"></a>00658                         $Login = $this-&gt;Security-&gt;get( $Login , <span class="stringliteral">&#39;command&#39;</span> );
<a name="l00659"></a>00659                         $Password = $this-&gt;Security-&gt;get( $Password , <span class="stringliteral">&#39;string&#39;</span> );
<a name="l00660"></a>00660                         $Email = $this-&gt;Security-&gt;get( $Email , <span class="stringliteral">&#39;email&#39;</span> );
<a name="l00661"></a>00661                         $Name = $this-&gt;Security-&gt;get( $Name , <span class="stringliteral">&#39;string&#39;</span> );
<a name="l00662"></a>00662                         $Sex = $this-&gt;Security-&gt;get( $Sex , <span class="stringliteral">&#39;integer&#39;</span> );
<a name="l00663"></a>00663                         $Site = $this-&gt;Security-&gt;get( $Site , <span class="stringliteral">&#39;string&#39;</span> );
<a name="l00664"></a>00664                         $About = $this-&gt;Security-&gt;get( $About , <span class="stringliteral">&#39;string&#39;</span> );
<a name="l00665"></a>00665                         
<a name="l00666"></a>00666                         <span class="keywordflow">if</span>( $Sex != 1 &amp;&amp; $Sex != 2 )
<a name="l00667"></a>00667                         {
<a name="l00668"></a>00668                               $Sex = 0;
<a name="l00669"></a>00669                         }
<a name="l00670"></a>00670                         
<a name="l00671"></a>00671                         $Hash = md5( microtime() );
<a name="l00672"></a>00672 
<a name="l00673"></a>00673                         $this-&gt;Database-&gt;lock( array( $this-&gt;NativeTable ) , array( <span class="stringliteral">&#39;WRITE&#39;</span> ) );
<a name="l00674"></a>00674                         
<a name="l00675"></a>00675                         $this-&gt;Database-&gt;insert( 
<a name="l00676"></a>00676                               $this-&gt;NativeTable , 
<a name="l00677"></a>00677                               <span class="stringliteral">&quot;login , password , email , name , sex , active , registered , site , about&quot;</span> , 
<a name="l00678"></a>00678                               <span class="stringliteral">&quot;&#39;$Login&#39; , md5( &#39;$Password&#39; ) , &#39;$Email&#39; , &#39;$Name&#39; , $Sex , &#39;$Hash&#39; , NOW() , &#39;$Site&#39; , &#39;$About&#39;&quot;</span>
<a name="l00679"></a>00679                         );
<a name="l00680"></a>00680                         $this-&gt;Database-&gt;commit();
<a name="l00681"></a>00681                         
<a name="l00682"></a>00682                         $id = $this-&gt;Database-&gt;select( <span class="charliteral">&#39;*&#39;</span> , $this-&gt;NativeTable , <span class="stringliteral">&#39;1 = 1 ORDER by id DESC LIMIT 0 , 1&#39;</span> );
<a name="l00683"></a>00683                         $id = <a class="code" href="functional__programming_8php.html#a113f39218a0e805d475fbc5ab87a16ab">get_field</a>( $id[ 0 ] , <span class="stringliteral">&#39;id&#39;</span> );
<a name="l00684"></a>00684                         
<a name="l00685"></a>00685                         $this-&gt;Database-&gt;unlock();
<a name="l00686"></a>00686                         
<a name="l00687"></a>00687                         $EventManager = <a class="code" href="core__public__api_8php.html#a3ba50cf690fa88e981b38b4779f18759">get_package</a>( <span class="stringliteral">&#39;event_manager&#39;</span> , <span class="stringliteral">&#39;last&#39;</span> , __FILE__ );
<a name="l00688"></a>00688                         $EventManager-&gt;trigger_event( <span class="stringliteral">&#39;on_after_create_user&#39;</span> , array( <span class="stringliteral">&#39;login&#39;</span> =&gt; $Login , <span class="stringliteral">&#39;id&#39;</span> =&gt; $id ) );
<a name="l00689"></a>00689                         
<a name="l00690"></a>00690                         $EventManager-&gt;trigger_event( <span class="stringliteral">&#39;anonimous&#39;</span> , array( <span class="stringliteral">&#39;master_id&#39;</span> =&gt; $id , <span class="stringliteral">&#39;master_type&#39;</span> =&gt; <span class="stringliteral">&#39;user&#39;</span> ) );
<a name="l00691"></a>00691                         
<a name="l00692"></a>00692                         <span class="keywordflow">return</span>( $Hash );
<a name="l00693"></a>00693                   }
<a name="l00694"></a>00694                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00695"></a>00695                   {
<a name="l00696"></a>00696                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00697"></a>00697                   }
<a name="l00698"></a>00698             }
<a name="l00699"></a>00699             
<a name="l00722"></a><a class="code" href="classuser__access__1__0__0.html#aa55100a506c6c0f59ece407e220b332f">00722</a>             function                <a class="code" href="classuser__access__1__0__0.html#aa55100a506c6c0f59ece407e220b332f">select_list</a>( $id )
<a name="l00723"></a>00723             {
<a name="l00724"></a>00724                   <span class="keywordflow">try</span>
<a name="l00725"></a>00725                   {
<a name="l00726"></a>00726                         $id = $this-&gt;Security-&gt;get( $id , <span class="stringliteral">&#39;integer_list&#39;</span> );
<a name="l00727"></a>00727 
<a name="l00728"></a>00728                         <span class="keywordflow">return</span>( $this-&gt;<a class="code" href="classuser__access__1__0__0.html#a43bcb1bbf7b5be538c27b03543c63208">unsafe_select</a>( $this-&gt;NativeTable.<span class="stringliteral">&quot;.id IN ( $id )&quot;</span> ) );
<a name="l00729"></a>00729                   }
<a name="l00730"></a>00730                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00731"></a>00731                   {
<a name="l00732"></a>00732                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00733"></a>00733                   }
<a name="l00734"></a>00734             }
<a name="l00735"></a>00735             
<a name="l00774"></a><a class="code" href="classuser__access__1__0__0.html#add7fea3c4c0e5ad2e51ea1d2d6e7cb57">00774</a>             function                <a class="code" href="classuser__access__1__0__0.html#add7fea3c4c0e5ad2e51ea1d2d6e7cb57">select</a>( $Start = <span class="keyword">false</span> , $Limit = <span class="keyword">false</span> , $Field = <span class="keyword">false</span> , 
<a name="l00775"></a>00775                                                                                                                         $Order = <span class="keyword">false</span> , $Condition = <span class="stringliteral">&#39;1 = 1&#39;</span> )
<a name="l00776"></a>00776             {
<a name="l00777"></a>00777                   <span class="keywordflow">try</span>
<a name="l00778"></a>00778                   {
<a name="l00779"></a>00779                         $Condition = $this-&gt;DatabaseAlgorithms-&gt;select_condition( 
<a name="l00780"></a>00780                               $Start , $Limit , $Field , $Order , $Condition
<a name="l00781"></a>00781                         );
<a name="l00782"></a>00782                         
<a name="l00783"></a>00783                         <span class="keywordflow">return</span>( $this-&gt;<a class="code" href="classuser__access__1__0__0.html#a43bcb1bbf7b5be538c27b03543c63208">unsafe_select</a>( $Condition ) );
<a name="l00784"></a>00784                   }
<a name="l00785"></a>00785                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00786"></a>00786                   {
<a name="l00787"></a>00787                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00788"></a>00788                   }
<a name="l00789"></a>00789             }
<a name="l00790"></a>00790             
<a name="l00825"></a><a class="code" href="classuser__access__1__0__0.html#a211b61efdf0d46b0a4fc610b2beb1654">00825</a>             function                <a class="code" href="classuser__access__1__0__0.html#a211b61efdf0d46b0a4fc610b2beb1654">update_user</a>( $Login , $Email , $Site , $About )
<a name="l00826"></a>00826             {
<a name="l00827"></a>00827                   <span class="keywordflow">try</span>
<a name="l00828"></a>00828                   {
<a name="l00829"></a>00829                         $Login = $this-&gt;Security-&gt;get( $Login , <span class="stringliteral">&#39;command&#39;</span> );
<a name="l00830"></a>00830                         $Email = $this-&gt;Security-&gt;get( $Email , <span class="stringliteral">&#39;email&#39;</span> );
<a name="l00831"></a>00831                         $Site = $this-&gt;Security-&gt;get( $Site , <span class="stringliteral">&#39;string&#39;</span> );
<a name="l00832"></a>00832                         $About = $this-&gt;Security-&gt;get( $About , <span class="stringliteral">&#39;string&#39;</span> );
<a name="l00833"></a>00833                         
<a name="l00834"></a>00834                         $this-&gt;Database-&gt;update( 
<a name="l00835"></a>00835                               $this-&gt;NativeTable , 
<a name="l00836"></a>00836                               array( <span class="stringliteral">&#39;email&#39;</span> , <span class="stringliteral">&#39;site&#39;</span> , <span class="stringliteral">&#39;about&#39;</span> ) , 
<a name="l00837"></a>00837                               array( <span class="stringliteral">&quot;&#39;$Email&#39;&quot;</span> , <span class="stringliteral">&quot;&#39;$Site&#39;&quot;</span> , <span class="stringliteral">&quot;&#39;$About&#39;&quot;</span> ) , 
<a name="l00838"></a>00838                               <span class="stringliteral">&quot;login LIKE &#39;$Login&#39;&quot;</span>
<a name="l00839"></a>00839                         );
<a name="l00840"></a>00840                         $this-&gt;Database-&gt;commit();
<a name="l00841"></a>00841                         
<a name="l00842"></a>00842                         $Users = $this-&gt;<a class="code" href="classuser__access__1__0__0.html#a43bcb1bbf7b5be538c27b03543c63208">unsafe_select</a>( <span class="stringliteral">&quot;login LIKE &#39;$Login&#39;&quot;</span> );
<a name="l00843"></a>00843                         $User = $Users[ 0 ];
<a name="l00844"></a>00844                         $id = <a class="code" href="functional__programming_8php.html#a113f39218a0e805d475fbc5ab87a16ab">get_field</a>( $User , <span class="stringliteral">&#39;id&#39;</span> );
<a name="l00845"></a>00845                         
<a name="l00846"></a>00846                         $EventManager = <a class="code" href="core__public__api_8php.html#a3ba50cf690fa88e981b38b4779f18759">get_package</a>( <span class="stringliteral">&#39;event_manager&#39;</span> , <span class="stringliteral">&#39;last&#39;</span> , __FILE__ );
<a name="l00847"></a>00847                         $EventManager-&gt;trigger_event( <span class="stringliteral">&#39;on_after_update_user&#39;</span> , array( <span class="stringliteral">&#39;id&#39;</span> =&gt; $id ) );
<a name="l00848"></a>00848                         
<a name="l00849"></a>00849                         $EventManager-&gt;trigger_event( <span class="stringliteral">&#39;anonimous&#39;</span> , array( <span class="stringliteral">&#39;master_id&#39;</span> =&gt; $id , <span class="stringliteral">&#39;master_type&#39;</span> =&gt; <span class="stringliteral">&#39;user&#39;</span> ) );
<a name="l00850"></a>00850                   }
<a name="l00851"></a>00851                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00852"></a>00852                   {
<a name="l00853"></a>00853                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00854"></a>00854                   }
<a name="l00855"></a>00855             }
<a name="l00856"></a>00856             
<a name="l00875"></a><a class="code" href="classuser__access__1__0__0.html#a2f7e0a5ad03312d5de7301891a2b4b5d">00875</a>             function                <a class="code" href="classuser__access__1__0__0.html#a2f7e0a5ad03312d5de7301891a2b4b5d">simple_select</a>()
<a name="l00876"></a>00876             {
<a name="l00877"></a>00877                   <span class="keywordflow">try</span>
<a name="l00878"></a>00878                   {
<a name="l00879"></a>00879                         $Records = $this-&gt;<a class="code" href="classuser__access__1__0__0.html#a43bcb1bbf7b5be538c27b03543c63208">unsafe_select</a>( <span class="stringliteral">&#39;1 = 1&#39;</span> );
<a name="l00880"></a>00880                         
<a name="l00881"></a>00881                         <span class="keywordflow">foreach</span>( $Records as $k =&gt; $v )
<a name="l00882"></a>00882                         {
<a name="l00883"></a>00883                               <span class="keywordflow">if</span>( $v-&gt;id )
<a name="l00884"></a>00884                               {
<a name="l00885"></a>00885                                     $Records[ $k ]-&gt;title = $v-&gt;login;
<a name="l00886"></a>00886                               }
<a name="l00887"></a>00887                               <span class="keywordflow">else</span>
<a name="l00888"></a>00888                               {
<a name="l00889"></a>00889                                     $Records[ $k ]-&gt;title = <span class="stringliteral">&#39;{lang:not_defined}&#39;</span>;
<a name="l00890"></a>00890                               }
<a name="l00891"></a>00891                         }
<a name="l00892"></a>00892                         
<a name="l00893"></a>00893                         <span class="keywordflow">return</span>( $Records );
<a name="l00894"></a>00894                   }
<a name="l00895"></a>00895                   <span class="keywordflow">catch</span>( Exception $e )
<a name="l00896"></a>00896                   {
<a name="l00897"></a>00897                         $a = func_get_args();<a class="code" href="core__utilities_8php.html#abfba210aa5ad8e9a273b3342263c2961">_throw_exception_object</a>( __METHOD__ , $a , $e );
<a name="l00898"></a>00898                   }
<a name="l00899"></a>00899             }
<a name="l00900"></a>00900       }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902 ?&gt;
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Mon Oct 3 2011 14:49:56 for ultimix by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
